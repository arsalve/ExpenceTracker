<!DOCTYPE html>

<head>
    <title>वैयक्तिक खातेवही</title>

    <head>
        <script>
            var url = '';
            if (window.location.href.includes("localhost:8080")) {
                url = "http://localhost:8080";
            } else {
                url = "https://kharchapani.onrender.com/";
            }
        </script>
        <!-- Bootstrap CDN -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <!-- Monokai dark theme -->
        <style>
            body {
                background-color: #272822;
                color: #f8f8f2;
            }

            .form-control {
                background-color: #49483e;
                border-color: #75715e;
                color: #f8f8f2;
                width: 100%;
                height: 20%;

            }

            .btn-primary {
                background-color: #66d9ef;
                border-color: #66d9ef;
                color: #272822;
            }

            /* Add some style for the table */
            table {
                border-collapse: collapse;
                width: 80%;
                margin: 20px auto;
            }

            th,
            td {
                border: 1px solid #75715e;
                padding: 10px;
            }

            th {
                background-color: #49483e;
            }
        </style>
    </head>

<body>
    <h1>वैयक्तिक खातेवही</h1>
    <div class="form-control">
        <form class="form-group" class="form-group" action="" method="post">
            <table>
                <tr>
                    <th>दिनांक</th>
                    <th>रक्कम</th>
                    <th>प्रकार </th>
                    <th>तपशील</th>
                </tr>

                <tr class="input-field-container">
                    <td><input type="date" name="date" required></td>
                    <td><input id="ammount" type="number" name="amount" required></td>
                    <td><select name="type">
                            <option value="credit">मिळकत</option>
                            <option value="debit">खर्च</option>
                            <option value="Savings">बचत </option>
                        </select></td>
                    <td>
                        <select name="description" type="text" class="form-control selectWidth" id="ExpenseType"
                            list="options" name="ExpenseType">
                            <data-list class="dropdown-menu" id="options">
                                <option class="dropdown-item" value="Salary">Salary</option>
                                <option class="dropdown-item" value="Income Other">Income Other</option>
                                <option class="dropdown-item" value="intrest">Income Other</option>
                                <option class="dropdown-item" value="Savings - MF">Savings - MF</option>
                                <option class="dropdown-item" value="Savings - Bank">Savings - Bank</option>
                                <option class="dropdown-item" value="Savings - Other">Savings - Other</option>
                                <option class="dropdown-item" value="Food">Food</option>
                                <option class="dropdown-item" value="Fuel">Fuel</option>
                                <option class="dropdown-item" value="Vehicle Maintenance">Vehicle Maintenance</option>
                                <option class="dropdown-item" value="Cash">Cash</option>
                                <option class="dropdown-item" value="Exp Other">Exp Other</option>
                            </data-list>
                    </td></select>
                </tr>
                <tr>
                    <td colspan="4"><input id="saveData" class="btn-primary text-center" type="submit" value="नोंद करा">
                    </td>
                </tr>
            </table>
        </form>
    </div>

    <div id=displaydata>
        <!-- Add another table element to display the entries -->
        <div class="form-control2">
            <form class="form-group" class="form-group">
                <table>
                    <tr>
                        <th>दिनांक</th>
                        <th>
                            <div class="form-group">
                                <label for="selectDate">महिना व वर्ष निवडा</label>
                                <input type="Month" id="selectMonth" class="form-control selectWidth" required>
                                </select>
                            </div>
                        </th>
                        <th colspan="4"><input class="btn-primary text-center" onclick="displayData()" value="शोधा">
                        </th>
                    </tr>
                </table>
            </form>
        </div>
        <h3>खात्या चा तपशील</h3>
        <table id="summury">
            <!-- Add a table header row with four columns -->
            <tr>
                <th>प्रकार</th>
                <th>रक्कम</th>
            </tr>

        </table>
        <h3>व्यवहार तपशील</h3>
        <table id="entries">
            <!-- Add a table header row with four columns -->
            <tr>
                <th>क्रमांक </th>
                <th>दिनांक</th>
                <th>रक्कम</th>
                <th>प्रकार </th>
                <th>तपशील</th>
            </tr>

        </table>
    </div>
</body>


<script type="text/javascript">
    var form = document.querySelector('form');
    var table = document.querySelector('table');
    var data = [];

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        var formData = new FormData(form);
        var date = formData.get('date');
        var month = date.split("-")[1];
        var year = date.split("-")[0];
        var amount = formData.get('amount');
        var type = formData.get('type');
        var description = formData.get('description');
        var id = Date.now();
        var user = location.hash||"#"+prompt("enter your name");
        var transaction = {
            date,
            amount,
            type,
            description,
            id,
            year,
            month,
        };
        var req = {
            user: user,
            "transaction": [transaction]
        }
        //data.push(req);
        var json = JSON.stringify(req);

        debugger;
        // Make an AJAX request to your server
        var xhr = new XMLHttpRequest();
        xhr.open('POST', url + '/Insert', true);
        xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
        xhr.send(json);
        document.getElementById("saveData").hidden = true;
        xhr.onreadystatechange = () => {
            if (xhr.readyState === 4) {
                data = [];
                alert("Entry Saved");
                document.getElementById("saveData").hidden = false;
                document.getElementById("ammount").value = "";
            }
        }

    });
    const tableog = document.getElementById("entries").innerHTML;
    const summuryog = document.getElementById("summury").innerHTML;
    // Get the table element from HTML
    function displayData() {
        document.getElementById("entries").innerHTML=tableog;
        document.getElementById("summury").innerHTML=summuryog;
        var table = document.getElementById("entries");
        var summury = document.getElementById("summury");


        var data = {
            user:location.hash||"#"+prompt("enter your name") ,
            month: document.querySelector("#selectMonth").value.split("-")[1],
            year: document.querySelector("#selectMonth").value.split("-")[0]
        }

        fetch(url + "/find", {
                method: "POST", // or 'PUT'
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data)
            })
            .then((res) => {
                // Convert the response into a JSON object 
                var total = 0;
                var savings = 0;
                var expence = 0;
                var income = 0;
                res.json().then((data) => {
                    // Loop through the data
                    var TX = data[0].transaction;
                    TX.forEach((item) => {
                        // Get the month from the date

                        // Create a new table row
                        var row = document.createElement("tr");
                        var cell1 = document.createElement("td");
                        cell1.innerHTML = item.id;
                        row.appendChild(cell1);
                        // Create and append cells for each column
                        var cell1 = document.createElement("td");
                        cell1.innerHTML = item.date;
                        row.appendChild(cell1);

                        var cell2 = document.createElement("td");
                        cell2.innerHTML = item.amount;
                        row.appendChild(cell2);

                        var cell3 = document.createElement("td");
                        cell3.innerHTML = item.type;
                        row.appendChild(cell3);

                        var cell4 = document.createElement("td");
                        cell4.innerHTML = item.description;
                        row.appendChild(cell4);

                        // Append the row to the table
                        table.appendChild(row);
                        if (item.type == "credit") {
                            total = total + Number(item.amount);
                            income = income + Number(item.amount);
                        } else if (item.type == "savings") {
                            savings = savings + Number(item.amount);
                            total = total - Number(item.amount);
                        } else {
                            total = total - Number(item.amount);
                            expence = expence + Number(item.amount);
                        }

                    });


                    var IncomeRow = document.createElement("tr");

                    // Create and append cells for each column
                    var cell1 = document.createElement("td");
                    cell1.innerHTML = "एकूण  उत्पन्न";
                    IncomeRow.appendChild(cell1);

                    var cell2 = document.createElement("td");
                    cell2.innerHTML = income;
                    IncomeRow.appendChild(cell2);

                    // Append the row to the table
                    summury.appendChild(IncomeRow);


                    var expenceRow = document.createElement("tr");
                 
                    // Create and append cells for each column
                    var cell1 = document.createElement("td");
                    cell1.innerHTML = "एकूण खर्च";
                    expenceRow.appendChild(cell1);

                    var cell2 = document.createElement("td");
                    cell2.innerHTML = expence;
                    expenceRow.appendChild(cell2);

                    // Append the row to the table
                    summury.appendChild(expenceRow);

                    var Savingsrow = document.createElement("tr");
                    // Create and append cells for each column
                    var cell1 = document.createElement("td");
                    cell1.innerHTML = "एकूण बचत";
                    Savingsrow.appendChild(cell1);

                    var cell2 = document.createElement("td");
                    cell2.innerHTML = savings;
                    Savingsrow.appendChild(cell2);

                    // Append the row to the table
                    summury.appendChild(Savingsrow);

                    var Totalrow = document.createElement("tr");

                    // Create and append cells for each column
                    var cell1 = document.createElement("td");
                    cell1.innerHTML = "शिल्लक रक्कम";
                    Totalrow.appendChild(cell1);

                    var cell2 = document.createElement("td");
                    cell2.innerHTML = total;
                    Totalrow.appendChild(cell2);

                    // Append the row to the table
                    summury.appendChild(Totalrow);
                });
            })
            .catch((err) => {
                // Handle any errors
                console.log(err);
            });
    }
</script>

</html>
